/* pg_trace_ultimate.bt */

BEGIN {
    printf("ğŸš€ PostgreSQL Real-time Monitor Started...\n");
    printf("%-10s %-8s %-10s %-10s %-10s %s\n", 
           "TIME", "PID", "USER", "DB", "LATENCY", "EVENT/SQL");
    printf("--------------------------------------------------------------------------------\n");
}

/* * 1. æ•æ‰æŸ¥è¯¢èµ·ç‚¹
 * arg0: SQL æ–‡æœ¬
 */
usdt:/usr/local/pgsql/bin/postgres:query__start {
    @q_start[pid] = nsecs;
    @q_string[pid] = str(arg0);
    // åŒæ—¶ä¹Ÿè®°å½•è¿›å…¥è¿™ä¸ªäº‹ä»¶çš„æ—¶é—´æˆ³ï¼Œç”¨äºå¤šé˜¶æ®µåˆ†æ
    @last_event_ts[pid] = nsecs;
}

/* * 2. æ•æ‰äº‹åŠ¡ ID
 * arg0: Transaction ID
 */
usdt:/usr/local/pgsql/bin/postgres:transaction__start {
    @xid_map[pid] = (uint32)arg0;
}

/* * 3. æ•æ‰æŸ¥è¯¢ç»“æŸ (åœ¨è¿™é‡Œåšä¸»è¦çš„è€—æ—¶è¾“å‡º)
 */
usdt:/usr/local/pgsql/bin/postgres:query__done /@q_start[pid]/ {
    $now = nsecs;
    $duration = ($now - @q_start[pid]) / 1000000; // ms
    
    // å¦‚æœè€—æ—¶è¶…è¿‡ 10ms æ‰æ‰“å°ï¼Œå‡å°‘å±å¹•åˆ·æ–°è´Ÿæ‹…
    if ($duration >= 10) {
        printf("%-10s %-8d %-10s %-10s %-10d %s\n", 
               timestr($now), pid, username, "-", $duration, @q_string[pid]);
    }

    delete(@q_start[pid]);
    delete(@q_string[pid]);
    delete(@last_event_ts[pid]);
}

/* * 4. æ•æ‰äº‹åŠ¡æäº¤
 * è¿™é‡Œå¯ä»¥è§‚å¯Ÿäº‹åŠ¡ä» Query Done åˆ° Commit ä¹‹é—´çš„é—´éš™ï¼ˆå¯èƒ½æ˜¯åˆ·ç›˜å»¶è¿Ÿï¼‰
 */
usdt:/usr/local/pgsql/bin/postgres:transaction__commit /@xid_map[pid]/ {
    $xid = @xid_map[pid];
    printf("%-10s %-8d %-10s %-10s %-10s [TX_COMMIT] XID: %u\n", 
           timestr(nsecs), pid, username, "-", "-", $xid);
    
    delete(@xid_map[pid]);
}

/* * 5. é”™è¯¯å¤„ç†ï¼šæ­»é”ã€è¯­æ³•é”™è¯¯ç­‰å¯¼è‡´çš„å¼‚å¸¸é€€å‡º
 */
usdt:/usr/local/pgsql/bin/postgres:query__error {
    printf("%-10s %-8d %-10s %-10s %-10s [ERROR] Query Failed! SQL: %s\n", 
           timestr(nsecs), pid, username, "-", "-", @q_string[pid]);
    delete(@q_start[pid]);
    delete(@q_string[pid]);
}

/* * 6. ç»Ÿè®¡ï¼šç”Ÿæˆè€—æ—¶ç›´æ–¹å›¾ (åœ¨é€€å‡ºæ—¶å±•ç¤º)
 */
usdt:/usr/local/pgsql/bin/postgres:query__done {
    @latency_dist_ms = hist((nsecs - @q_start[pid]) / 1000000);
}

END {
    printf("\nğŸ“Š SQL Latency Distribution (ms):\n");
    clear(@q_start);
    clear(@q_string);
    clear(@xid_map);
    clear(@last_event_ts);
}
