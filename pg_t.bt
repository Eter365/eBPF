#!/usr/bin/bpftrace

config = { missing_probes = "warn" }

BEGIN {
    printf("ğŸš€ PostgreSQL Monitor: SQL Trace + Latency Histogram\n");
    printf("Tracing... Press Ctrl+C to stop and view the distribution map.\n");
    printf("--------------------------------------------------------------------------------\n");
    printf("%-10s %-12s %-8s %-10s %s\n", "TIME", "REQ_ID", "PID", "LATENCY", "SQL_TEXT");
}

/* 1. SQL å¼€å§‹ */
usdt:/usr/local/pgsql/bin/postgres:query__start {
    $ts = nsecs;
    @q_start[pid] = $ts;
    @q_string[pid] = str(arg0);
    @q_group_id[pid] = $ts % 1000000; 
}

/* 2. SQL ç»“æŸ */
usdt:/usr/local/pgsql/bin/postgres:query__done /@q_start[pid]/ {
    $lat_ms = (nsecs - @q_start[pid]) / 1000000;
    $gid = @q_group_id[pid];

    // æ‰“å°å®æ—¶æµæ°´
    time("%H:%M:%S  ");
    printf("%-12u %-8d %-10d ms %s\n", $gid, pid, $lat_ms, @q_string[pid]);

    // ã€æ ¸å¿ƒäº®ç‚¹ã€‘å°†è€—æ—¶å­˜å…¥ç›´æ–¹å›¾ Map
    // lhist(æ•°æ®, æœ€å°å€¼, æœ€å¤§å€¼, æ­¥é•¿) -> è¿™é‡Œå±•ç¤º 0-100ms ä¹‹é—´çš„çº¿æ€§åˆ†å¸ƒ
    @latency_distribution_ms = lhist($lat_ms, 0, 100, 10);
    
    // å¦‚æœæœ‰ææ…¢çš„ SQLï¼ˆè¶…è¿‡ 100msï¼‰ï¼Œè®°å½•åœ¨å¯¹æ•°åˆ†å¸ƒé‡Œçœ‹å…¨å±€
    @latency_overview_ms = hist($lat_ms);

    delete(@q_start[pid]);
    delete(@q_string[pid]);
    delete(@q_group_id[pid]);
}

/* 3. é”™è¯¯æ¸…ç† */
usdt:/usr/local/pgsql/bin/postgres:query__error {
    delete(@q_start[pid]);
    delete(@q_string[pid]);
    delete(@q_group_id[pid]);
}

END {
    printf("\n\nğŸ“Š SQL Latency Distribution Report (ms):\n");
    // é€€å‡ºæ—¶è‡ªåŠ¨æ‰“å° @latency_distribution_ms å’Œ @latency_overview_ms
}
